<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Alist-Sync 配置</title>
	<link rel="icon" href="../static/images/favicon.ico" type="image/x-icon">
	<link href="../static/layui/css/layui.css" rel="stylesheet">
	<link href="../static/css/all.min.css" rel="stylesheet">
	<style>
		.main-container {
			width: 80%;
			margin: 20px auto;
			max-width: 1200px;
		}

		.page-header {
			text-align: center;
			margin-bottom: 30px;
		}

		.page-header img {
			width: 64px;
			height: 64px;
		}

		.page-header h1 {
			margin: 10px 0;
			color: #009688;
		}

		.layui-btn-gray {
			background-color: #CCCCCC;
		}

		.next-run-time {
			padding: 5px 0;
			line-height: 1.8;
			color: #666;
			min-height: 30px;
			background-color: #f8f8f8;
			border-radius: 2px;
		}

		.next-run-time div {
			margin-bottom: 3px;
			padding: 0 10px;
		}

		/* 添加退出按钮样式 */
		.logout-btn {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 999;
		}

		/* 修改按钮组样式 */
		.header-btns {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 999;
		}

		.header-btns .layui-btn {
			margin-left: 10px;
		}

		.star-tips {
			text-align: center;
			font-size: 16px;
		}

		.link-group {
			display: flex;
			justify-content: center;
			gap: 15px;
		}

		.link-group .layui-btn {
			padding: 0 15px;
			height: 32px;
			line-height: 32px;
			border-radius: 4px;
			transition: all 0.3s;
			display: inline-flex;
			align-items: center;
			gap: 5px;
		}

		.link-group .layui-btn i {
			font-size: 16px;
		}

		.link-group .github:hover {
			color: #24292e;
			border-color: #24292e;
		}

		.link-group .gitee:hover {
			color: #c71d23;
			border-color: #c71d23;
		}

		.link-group .dockerhub:hover {
			color: #099cec;
			border-color: #099cec;
		}

		/* 移动端适配样式 */
		@media screen and (max-width: 768px) {
			.main-container {
				width: 95%;
				margin: 10px auto;
			}

			/* 调整头部按钮位置 */
			.header-btns {
				position: static;
				text-align: center;
				margin: 10px 0;
			}

			.header-btns .layui-btn {
				margin: 5px;
			}

			/* 调整表单项布局 */
			.layui-form-label {
				width: auto;
				padding: 9px 0;
				text-align: left;
				float: none;
			}

			.layui-input-block,
			.layui-input-inline {
				margin-left: 0 !important;
				width: 100% !important;
			}

			/* 调整路径对布局 */
			.path-pair {
				display: flex;
				flex-direction: column;
				gap: 10px;
			}

			.path-pair .layui-form-label {
				padding: 5px 0;
			}

			.path-pair .layui-input-inline {
				margin-right: 0;
			}

			/* 调整按钮组布局 */
			.layui-form-item .layui-input-block {
				margin-left: 0;
				text-align: center;
			}

			.layui-form-item .layui-input-block .layui-btn {
				margin: 5px;
			}

			/* 调整链接组布局 */
			.link-group {
				flex-wrap: wrap;
			}

			/* 调整同步目标差异处置策略布局 */
			.syncDelAction-group {
				display: flex;
				flex-direction: column;
				gap: 5px;
			}
		}

		/* 文件上传样式优化 */
		.layui-form input[type="file"] {
			border: 1px dashed #e6e6e6;
			padding: 8px;
			margin-bottom: 10px;
		}

		.layui-form-mid.layui-text-em {
			text-align: center;
			padding: 8px 0;
			color: #999;
		}

		/* 移动端适配 */
		@media screen and (max-width: 768px) {
			.layui-layer {
				width: 95% !important;
				left: 2.5% !important;
			}
		}

		.version-info {
			border-top: 1px solid #eee;
			font-size: 14px;
		}

		.version-info span {
			font-family: monospace;
			padding: 2px 5px;
			background: #f8f8f8;
			border-radius: 3px;
		}

		.regex-tag {
			display: inline-block;
			background: #009688;
			/* 使用 layui 默认按钮颜色 */
			border: 1px solid #009688;
			/* 边框颜色 */
			padding: 2px 8px;
			margin: 2px;
			border-radius: 3px;
			font-size: 12px;
			color: #fff;
			/* 文字使用白色 */
		}

		.regex-tag .close {
			margin-left: 5px;
			cursor: pointer;
			color: #fff;
			/* 关闭按钮使用白色 */
		}

		.regex-tag .close:hover {
			color: #d9d9d9;
			/* 鼠标悬停时使用浅灰色 */
		}

		.regex-input {
			display: inline-block;
			vertical-align: middle;
		}

		.regex-input-container {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			gap: 5px;
			border: 1px solid #e6e6e6;
			padding: 5px;
			min-height: 38px;
			background-color: #fff;
			transition: border-color 0.3s;
			/* 添加过渡效果 */
		}

		.regex-input-container:focus-within {
			border-color: #009688;
			/* 输入框获得焦点时边框颜色与按钮一致 */
		}
	</style>
</head>

<body>
	<div class="header-btns">
		<button type="button" class="layui-btn layui-btn-normal" id="changePassword">
			<i class="layui-icon layui-icon-password"></i> 修改密码 </button>
		<button type="button" class="layui-btn layui-btn-danger" id="logoutBtn">
			<i class="layui-icon layui-icon-logout"></i> 退出 </button>
	</div>
	<div class="layui-container">
		<div id="loading" style="display: none;">
			<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 正在加载配置...
		</div>
	</div>
	<div class="main-container">
		<div class="page-header">
			<img src="../static/images/logo.png" alt="Alist-Sync">
			<h1>Alist-Sync 配置中心</h1>
			<!-- 添加 Star 提示 -->
			<div class="star-tips" style="margin: 15px 0; color: #666;"> 如果好用，请Star！非常感谢！ <div class="link-group"
					style="margin-top: 10px;">
					<a href="https://github.com/xjxjin/alist-sync" target="_blank"
						class="layui-btn layui-btn-primary github">
						<i class="fab fa-github"></i> GitHub </a>
					<a href="https://gitee.com/xjxjin/alist-sync" target="_blank"
						class="layui-btn layui-btn-primary gitee">
						<i class="fab fa-git-alt"></i> Gitee </a>
					<a href="https://hub.docker.com/r/xjxjin/alist-sync" target="_blank"
						class="layui-btn layui-btn-primary dockerhub">
						<i class="fab fa-docker"></i> DockerHub </a>
				</div>
			</div>
		</div>
		<form class="layui-form" action="javascript:void(0);">
			<!-- 基础参数设置 -->
			<div class="layui-card">
				<div class="layui-card-header">基础连接参数</div>
				<div class="layui-card-body">
					<table class="layui-table" id="baseConfigTable">
						<thead>
							<tr>
								<th>服务地址</th>
								<th>用户名</th>
								<th>连接状态</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<!-- 基础配置将通过JS加载 -->
						</tbody>
					</table>
				</div>
			</div>

			<!-- 通知配置 -->
			<div class="layui-card" style="margin-top: 15px;">
				<div class="layui-card-header">通知配置</div>
				<div class="layui-card-body">
					<table class="layui-table" id="notifyConfigTable">
						<thead>
							<tr>
								<th>Bark URL</th>
								<th>Bark Key</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<!-- 通知配置将通过JS加载 -->
						</tbody>
					</table>
				</div>
			</div>
			<!-- 同步设置 -->
			<div class="layui-card" style="margin-top: 15px;">
				<div class="layui-card-header"> 同步配置 <button type="button"
						class="layui-btn layui-btn-xs layui-btn-normal" id="addTaskBtn">
						<i class="layui-icon">&#xe654;</i> 添加任务 </button>
				</div>
				<div class="layui-card-body">
					<table class="layui-table" id="taskTable">
						<thead>
							<tr>
								<th>ID</th>
								<th>任务名称</th>
								<th>同步模式</th>
								<th>Cron表达式</th>
								<th>随机延迟</th>
								<th>状态/下次运行</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody>
							<!-- 任务列表将通过JS加载 -->
						</tbody>
					</table>
				</div>
			</div>
	</div>

	<!-- 任务编辑弹窗模板 -->
	<script type="text/html" id="taskEditModal">
        <form class="layui-form" id="taskForm" lay-filter="taskForm" style="padding: 20px;">
            <input type="hidden" name="id">
            <div class="layui-form-item">
                <label class="layui-form-label">任务名称</label>
                <div class="layui-input-block">
                    <input type="text" name="taskName" required lay-verify="required" placeholder="请输入任务名称" class="layui-input">
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">同步模式</label>
                <div class="layui-input-block">
                    <input type="radio" name="syncMode" value="data" title="数据同步" checked lay-filter="modalSyncMode">
                    <input type="radio" name="syncMode" value="file" title="文件同步" lay-filter="modalSyncMode">
                    <input type="radio" name="syncMode" value="file_move" title="文件移动" lay-filter="modalSyncMode">
                </div>
            </div>

            <!-- 数据同步配置 -->
            <div class="data-sync-config">
                <div class="layui-form-item">
                    <label class="layui-form-label">源存储器</label>
                    <div class="layui-input-block">
                        <select name="sourceStorage" id="modalSourceStorage">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">目标存储器</label>
                    <div class="layui-input-block" id="modalTargetStorages">
                        <!-- 动态生成 -->
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">同步目录</label>
                    <div class="layui-input-block">
                        <input type="text" name="syncDirs" placeholder="多个目录用英文逗号分隔" class="layui-input">
                    </div>
                </div>
            </div>

            <!-- 文件同步/移动配置 -->
            <div class="file-sync-config" style="display:none;">
                <div id="modalPathPairs">
                    <!-- 动态添加路径对 -->
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="addPathPairBtn">
                            <i class="layui-icon">&#xe654;</i> 添加路径对
                        </button>
                    </div>
                </div>
            </div>

             <!-- 差异处理策略 -->
             <div class="layui-form-item">
                <label class="layui-form-label">差异策略</label>
                <div class="layui-input-block">
                    <input type="radio" name="syncDelAction" value="none" title="不处理" checked>
                    <input type="radio" name="syncDelAction" value="move" title="移至回收站">
                    <input type="radio" name="syncDelAction" value="delete" title="删除">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">排除目录</label>
                <div class="layui-input-block">
                    <input type="text" name="excludeDirs" placeholder="多个目录用英文逗号分隔" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">正则表达式</label>
                <div class="layui-input-block">
                    <input type="text" name="regexPatterns" placeholder="匹配文件名正则" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">Cron表达式</label>
                    <div class="layui-input-inline">
                        <input type="text" name="cron" required lay-verify="required" placeholder="* * * * *" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">随机延迟(s)</label>
                    <div class="layui-input-inline">
                        <input type="number" name="randomDelay" placeholder="0" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item" style="text-align: right;">
                <button class="layui-btn" lay-submit lay-filter="submitTask">保存任务</button>
                <button type="button" class="layui-btn layui-btn-primary" id="cancelTaskBtn">取消</button>
            </div>
        </form>
    </script>

	<!-- 基础配置编辑弹窗模板 -->
	<script type="text/html" id="baseConfigModalTpl">
        <form class="layui-form" id="baseConfigForm" lay-filter="baseConfigForm" style="padding: 20px;">
            <div class="layui-form-item">
                <label class="layui-form-label">服务地址</label>
                <div class="layui-input-block">
                    <input type="text" name="baseUrl" required lay-verify="required" placeholder="请输入URL" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">用户名</label>
                <div class="layui-input-block">
                    <input type="text" name="username" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">密码</label>
                <div class="layui-input-block">
                    <input type="password" name="password" placeholder="请输入密码" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">令牌</label>
                <div class="layui-input-block">
                    <input type="password" name="token" placeholder="请输入令牌" autocomplete="off" class="layui-input">
                </div>
            </div>
             <div class="layui-form-item" style="text-align: right;">
                <button type="button" class="layui-btn layui-btn-normal" id="testBaseConnectInModal">测试连接</button>
                <button class="layui-btn" lay-submit lay-filter="submitBaseConfig">保存</button>
                <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
            </div>
        </form>
    </script>

	<!-- 通知配置编辑弹窗模板 -->
	<script type="text/html" id="notifyConfigModalTpl">
        <form class="layui-form" id="notifyConfigForm" lay-filter="notifyConfigForm" style="padding: 20px;">
            <div class="layui-form-item">
                <label class="layui-form-label">Bark URL</label>
                <div class="layui-input-block">
                    <input type="text" name="barkUrl" placeholder="默认为 https://api.day.app" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">Bark Key</label>
                <div class="layui-input-block">
                    <input type="text" name="barkKey" placeholder="请输入Bark Key" autocomplete="off" class="layui-input">
                </div>
            </div>
             <div class="layui-form-item" style="text-align: right;">
                <button class="layui-btn" lay-submit lay-filter="submitNotifyConfig">保存</button>
                <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
            </div>
        </form>
    </script>
	<!-- 操作按钮 -->
	<div class="layui-form-item" style="margin-top: 15px;">
		<div class="layui-input-block" style="margin-left: 0; text-align: center;">
			<button type="button" class="layui-btn" id="saveSyncConfig">保存同步配置</button>
			<button type="button" class="layui-btn layui-btn-normal" id="runTask">立即执行</button>
			<button type="button" class="layui-btn layui-btn-primary" id="viewLogs">查看日志</button>
			<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			<!-- 新增导入导出按钮 -->
			<button type="button" class="layui-btn layui-btn-warm" id="exportConfig">导出配置</button>
			<button type="button" class="layui-btn layui-btn-warm" id="importConfig">导入配置</button>
		</div>
	</div>
	</form>
	<div class="version-info" style="text-align: center; margin-top: 20px; padding: 10px; color: #666;">
		<div> 当前版本: <span id="currentVersion">加载中...</span> &nbsp;&nbsp;|&nbsp;&nbsp; 最新版本: <span
				id="latestVersion">加载中...</span>
		</div>
	</div>
	</div>
	<script src="../static/layui/layui.js"></script>
	<script type="text/html" id="changePasswordTpl">
		<form class="layui-form" style="padding: 20px;" lay-filter="changePasswordForm">
			<div class="layui-form-item">
				<label class="layui-form-label">当前用户名</label>
				<div class="layui-input-block">
					<input type="text" name="oldUsername" class="layui-input" disabled>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">新用户名</label>
				<div class="layui-input-block">
					<input type="text" name="newUsername" required lay-verify="required" placeholder="请输入新用户名" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">原密码</label>
				<div class="layui-input-block">
					<input type="password" name="oldPassword" required lay-verify="required" placeholder="请输入原密码" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">新密码</label>
				<div class="layui-input-block">
					<input type="password" name="newPassword" required lay-verify="required" placeholder="请输入新密码" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">确认密码</label>
				<div class="layui-input-block">
					<input type="password" name="confirmPassword" required lay-verify="required" placeholder="请再次输入新密码" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-input-block">
					<button class="layui-btn" lay-submit lay-filter="changePasswordSubmit">确认修改</button>
				</div>
			</div>
		</form>
	</script>
	<script type="text/html" id="logsViewTpl">
		<div style="padding: 15px;">
			<div class="layui-form">
				<div class="layui-form-item" style="margin-bottom: 10px;">
					<div class="layui-inline" style="width: 100%; margin-right: 0;">
						<input type="text" class="layui-input" id="logDate" placeholder="选择日期" style="margin-bottom: 10px;">
						<button type="button" class="layui-btn layui-btn-primary layui-btn-fluid" id="refreshLogs">刷新</button>
					</div>
				</div>
			</div>
			<div class="logs-content" style="margin-top: 10px; max-height: 70vh; overflow-y: auto;">
			</div>
		</div>
	</script>
	<script type="text/html" id="importConfigTpl">
		<form class="layui-form" style="padding: 20px;">
			<div class="layui-form-item">
				<label class="layui-form-label">配置类型</label>
				<div class="layui-input-block">
					<input type="radio" name="configType" value="base" title="基础配置" lay-filter="configType" checked>
					<input type="radio" name="configType" value="sync" title="同步配置" lay-filter="configType">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">配置文件</label>
				<div class="layui-input-block">
					<input type="file" name="configFile" accept=".json" class="layui-input">
					<div class="layui-form-mid layui-text-em">或</div>
					<textarea name="configContent" placeholder="粘贴配置文件内容" class="layui-textarea" style="height: 200px;"></textarea>
				</div>
			</div>
		</form>
	</script>
	<script>
		layui.use(['form', 'layer', 'laydate'], function () {
			var form = layui.form,
				layer = layui.layer,
				laydate = layui.laydate,
				$ = layui.$;  // 使用 layui 的 jQuery

			// 页面加载时的初始化代码
			$(document).ready(function () {
				console.log('页面加载完成');

				// 加载基础配置
				loadBaseConfig();

				// 加载存储器列表
				loadStorages().then(() => {
					// 加载任务列表
					loadTasks();
				}).catch(error => {
					console.error('加载存储器列表失败:', error);
				});

				// 绑定添加任务按钮
				$('#addTaskBtn').click(function () {
					openTaskModal();
				});

				// 事件委托绑定任务操作按钮
				$(document).on('click', '.edit-task-btn', function () {
					const id = $(this).data('id');
					editTask(id);
				});

				$(document).on('click', '.delete-task-btn', function () {
					const id = $(this).data('id');
					deleteTask(id);
				});

				$(document).on('click', '.run-task-btn', function () {
					console.log('Run task button clicked');
					const id = $(this).data('id');
					console.log('Task ID:', id);
					executeTask(id);
				});

				// 测试连接
				$('#testConnect').click(function () {
					const payload = {
						baseUrl: $('input[name="baseUrl"]').val(),
						username: $('input[name="username"]').val(),
						password: $('input[name="password"]').val(),
						token: $('input[name="token"]').val()
					};

					layer.load(1);
					$.ajax({
						url: '/api/test-connection',
						method: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(payload),
						success: function (res) {
							layer.closeAll('loading');
							if (res.code === 200) {
								layer.msg('连接成功');
							} else {
								layer.alert(res.message);
							}
						},
						error: function () {
							layer.closeAll('loading');
							layer.msg('连接测试失败');
						}
					});
				});

				// 保存基础配置
				form.on('submit(saveBaseConfig)', function (data) {
					layer.load(1);
					$.ajax({
						url: '/api/save-base-config',
						method: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(data.field),
						success: function (res) {
							layer.closeAll('loading');
							if (res.code === 200) {
								layer.msg('保存成功');
							} else {
								layer.alert(res.message);
							}
						},
						error: function () {
							layer.closeAll('loading');
							layer.msg('保存失败');
						}
					});
					return false;
				});
			});

			let currentStoragesList = [];

			// 加载存储器列表
			async function loadStorages() {
				try {
					const storagesRes = await $.ajax({
						url: '/api/storages',
						method: 'GET'
					});

					if (storagesRes.code === 200) {
						currentStoragesList = storagesRes.data;
					}
				} catch (error) {
					console.error('加载存储器列表失败:', error);
				}
			}

			// 加载基础配置和通知配置
			function loadBaseConfig() {
				$.get('/api/get-base-config', function (res) {
					if (res.code === 200 && res.data) {
						// 基础配置表格
						const baseTbody = $('#baseConfigTable tbody');
						baseTbody.empty();
						baseTbody.append(`
                            <tr>
                                <td>${res.data.baseUrl || '-'}</td>
                                <td>${res.data.username || '-'}</td>
                                <td id="baseConnectStatus">未知</td>
                                <td>
                                    <button class="layui-btn layui-btn-xs" id="editBaseBtn">编辑</button>
                                    <button class="layui-btn layui-btn-xs layui-btn-gray" id="testBaseConnect">连接测试</button>
                                </td>
                            </tr>
                        `);

						// 通知配置表格
						const notifyTbody = $('#notifyConfigTable tbody');
						notifyTbody.empty();
						notifyTbody.append(`
                            <tr>
                                <td>${res.data.barkUrl || '默认'}</td>
                                <td>${res.data.barkKey ? '********' : '未设置'}</td>
                                <td>
                                    <button class="layui-btn layui-btn-xs" id="editNotifyBtn">编辑</button>
                                </td>
                            </tr>
                        `);
					}
				});
			}

			// 事件委托处理基础配置和通知配置的操作
			$(document).on('click', '#editBaseBtn', function () {
				$.get('/api/get-base-config', function (res) {
					if (res.code === 200) {
						layer.open({
							type: 1,
							title: '编辑基础连接参数',
							area: ['500px', '450px'],
							content: $('#baseConfigModalTpl').html(),
							success: function (layero, index) {
								form.val('baseConfigForm', res.data);
								form.render(null, 'baseConfigForm');

								// 测试连接按钮
								layero.find('#testBaseConnectInModal').on('click', function () {
									testConnection(form.val('baseConfigForm'));
								});
							}
						});
					}
				});
			});

			$(document).on('click', '#testBaseConnect', function () {
				$.get('/api/get-base-config', function (res) {
					if (res.code === 200) {
						testConnection(res.data);
					}
				});
			});

			$(document).on('click', '#editNotifyBtn', function () {
				$.get('/api/get-base-config', function (res) {
					if (res.code === 200) {
						layer.open({
							type: 1,
							title: '编辑通知配置',
							area: ['500px', '350px'],
							content: $('#notifyConfigModalTpl').html(),
							success: function (layero, index) {
								form.val('notifyConfigForm', res.data);
								form.render(null, 'notifyConfigForm');
							}
						});
					}
				});
			});

			function testConnection(data) {
				layer.load(1);
				$.ajax({
					url: '/api/test-connection',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(data),
					success: function (res) {
						layer.closeAll('loading');
						layer.msg(res.message, { icon: res.code === 200 ? 1 : 2 });
						if ($('#baseConnectStatus').length) {
							$('#baseConnectStatus').text(res.code === 200 ? '连接成功' : '连接失败').css('color', res.code === 200 ? 'green' : 'red');
						}
					},
					error: function () {
						layer.closeAll('loading');
						layer.msg('连接请求失败');
					}
				});
			}

			// 监听配置表单提交
			form.on('submit(submitBaseConfig)', function (data) {
				layer.load(1);
				$.ajax({
					url: '/api/save-base-config',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(data.field),
					success: function (res) {
						layer.closeAll();
						if (res.code === 200) {
							layer.msg('基础配置已保存');
							loadBaseConfig();
							loadStorages(); // 重新加载存储器
						} else {
							layer.alert(res.message);
						}
					},
					error: function () {
						layer.closeAll('loading');
						layer.msg('保存失败');
					}
				});
				return false;
			});

			form.on('submit(submitNotifyConfig)', function (data) {
				layer.load(1);
				// 获取当前的基础配置，合并通知配置
				$.get('/api/get-base-config', function (baseRes) {
					if (baseRes.code === 200) {
						const merged = Object.assign({}, baseRes.data, data.field);
						$.ajax({
							url: '/api/save-base-config',
							method: 'POST',
							contentType: 'application/json',
							data: JSON.stringify(merged),
							success: function (res) {
								layer.closeAll();
								if (res.code === 200) {
									layer.msg('通知配置已保存');
									loadBaseConfig();
								} else {
									layer.alert(res.message);
								}
							}
						});
					}
				});
				return false;
			});

			// 加载任务列表
			function loadTasks() {
				$.get('/api/get-sync-config', function (res) {
					const tbody = $('#taskTable tbody');
					tbody.empty();

					if (res.code === 200 && res.data && res.data.tasks) {
						res.data.tasks.forEach(task => {
							const tr = `
                                <tr>
                                    <td>${task.id || ''}</td>
                                    <td>${task.taskName}</td>
                                    <td>${getSyncModeText(task.syncMode)}</td>
                                    <td>${task.cron}</td>
                                    <td>${task.randomDelay || 0}s</td>
                                    <td class="next-run-time-cell" data-cron="${task.cron}">计算中...</td>
                                    <td>
                                        <button class="layui-btn layui-btn-xs edit-task-btn" data-id="${task.id}">编辑</button>
                                        <button class="layui-btn layui-btn-xs layui-btn-danger delete-task-btn" data-id="${task.id}">删除</button>
                                        <button class="layui-btn layui-btn-xs layui-btn-normal run-task-btn" data-id="${task.id}">运行</button>
                                    </td>
                                </tr>
                            `;
							tbody.append(tr);
						});

						// 更新下次运行时间
						$('.next-run-time-cell').each(function () {
							const cell = $(this);
							const cron = cell.data('cron');
							updateNextRunTimeForCell(cell, cron);
						});
					}
				});
			}

			function getSyncModeText(mode) {
				const map = {
					'data': '数据同步',
					'file': '文件同步',
					'file_move': '文件移动'
				};
				return map[mode] || mode;
			}

			async function updateNextRunTimeForCell(cell, cron) {
				if (!cron) {
					cell.text('-');
					return;
				}
				try {
					const res = await $.ajax({
						url: '/api/next-run-time',
						method: 'POST',
						contentType: 'application/json',
						data: JSON.stringify({ cron: cron })
					});
					if (res.code === 200 && res.data && res.data.length > 0) {
						cell.text(res.data[0]);
					} else {
						cell.text('无法计算');
					}
				} catch (e) {
					cell.text('错误');
				}
			}

			function editTask(id) {
				$.get('/api/get-sync-config', function (res) {
					if (res.code === 200 && res.data && res.data.tasks) {
						const task = res.data.tasks.find(t => t.id === id);
						if (task) {
							openTaskModal(task);
						}
					}
				});
			};

			function deleteTask(id) {
				layer.confirm('确定要删除这个任务吗？', function (index) {
					$.ajax({
						url: '/api/task/delete',
						method: 'POST',
						contentType: 'application/json',
						data: JSON.stringify({ id: id }),
						success: function (res) {
							if (res.code === 200) {
								layer.msg('删除成功');
								loadTasks();
							} else {
								layer.alert(res.message);
							}
						}
					});
					layer.close(index);
				});
			};

			function executeTask(id) {
				$.ajax({
					url: '/api/run-task',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({ id: id }),
					success: function (res) {
						layer.msg(res.message);
					},
					error: function (e) {
						layer.msg('执行失败');
					}
				});
			};

			// 打开任务弹窗
			function openTaskModal(taskData = null) {
				layer.open({
					type: 1,
					title: taskData ? '编辑任务' : '添加任务',
					area: ['800px', '700px'],
					content: $('#taskEditModal').html(),
					success: function (layero, index) {
						const formElem = layero.find('form');
						// Need to give it a unique ID to avoid conflict if any (though we rendered it inside)
						formElem.attr('lay-filter', 'taskForm');
						form.render(null, 'taskForm');

						// 初始化存储器下拉
						const sourceSelect = formElem.find('select[name="sourceStorage"]');
						const targetDiv = formElem.find('#modalTargetStorages');

						sourceSelect.empty().append('<option value="">请选择</option>');
						targetDiv.empty();

						currentStoragesList.forEach(s => {
							sourceSelect.append(`<option value="${s}">${s}</option>`);
							targetDiv.append(`<input type="checkbox" name="targetStorages[]" value="${s}" title="${s}" lay-skin="primary">`);
						});

						// 监听同步模式切换
						form.on('radio(modalSyncMode)', function (data) {
							updateModalVisibility(formElem, data.value);
						});

						// 初始显示状态
						const mode = taskData ? taskData.syncMode : 'data';
						updateModalVisibility(formElem, mode);

						// 填充数据
						if (taskData) {
							formElem.find('input[name="id"]').val(taskData.id);
							formElem.find('input[name="taskName"]').val(taskData.taskName);
							// Set Radio
							formElem.find(`input[name="syncMode"][value="${taskData.syncMode}"]`).prop('checked', true);
							formElem.find(`input[name="syncDelAction"][value="${taskData.syncDelAction}"]`).prop('checked', true);

							// Data Sync fields
							if (taskData.syncMode === 'data') {
								sourceSelect.val(taskData.sourceStorage);
								if (taskData.targetStorages) {
									taskData.targetStorages.forEach(s => {
										targetDiv.find(`input[value="${s}"]`).prop('checked', true);
									});
								}
								formElem.find('input[name="syncDirs"]').val(taskData.syncDirs);
							}

							// File paths
							if (taskData.paths && (taskData.syncMode === 'file' || taskData.syncMode === 'file_move')) {
								const container = formElem.find('#modalPathPairs');
								taskData.paths.forEach(path => {
									const src = taskData.syncMode === 'file' ? path.srcPath : path.srcPathMove;
									const dst = taskData.syncMode === 'file' ? path.dstPath : path.dstPathMove;
									addModalPathPair(container, src, dst);
								});
							}

							formElem.find('input[name="excludeDirs"]').val(taskData.excludeDirs);
							formElem.find('input[name="regexPatterns"]').val(taskData.regexPatterns);
							formElem.find('input[name="cron"]').val(taskData.cron);
							formElem.find('input[name="randomDelay"]').val(taskData.randomDelay);
						} else {
							// Default path pair for new task if mode is file (optional, but good UX)
							addModalPathPair(formElem.find('#modalPathPairs'));
						}

						form.render(null, 'taskForm'); // Refresh form inside modal

						// Path Add Button
						formElem.find('#addPathPairBtn').click(function () {
							addModalPathPair(formElem.find('#modalPathPairs'));
						});

						// Cancel Button
						formElem.find('#cancelTaskBtn').click(function () {
							layer.close(index);
						});

						// Form Submit
						form.on('submit(submitTask)', function (data) {
							const formData = data.field;
							// Construct task object
							const task = {
								id: formData.id ? parseInt(formData.id) : null,
								taskName: formData.taskName,
								syncMode: formData.syncMode,
								syncDelAction: formData.syncDelAction,
								excludeDirs: formData.excludeDirs,
								regexPatterns: formData.regexPatterns,
								cron: formData.cron,
								randomDelay: formData.randomDelay ? parseInt(formData.randomDelay) : 0
							};

							if (task.syncMode === 'data') {
								task.sourceStorage = formData.sourceStorage;
								task.syncDirs = formData.syncDirs;
								// Get checkboxes manually
								const targets = [];
								formElem.find('input[name="targetStorages[]"]:checked').each(function () {
									targets.push($(this).val());
								});
								task.targetStorages = targets;
							} else {
								// Collect paths
								task.paths = [];
								formElem.find('.path-pair-row').each(function () {
									const src = $(this).find('.src-path').val();
									const dst = $(this).find('.dst-path').val();
									if (src && dst) {
										if (task.syncMode === 'file') {
											task.paths.push({ srcPath: src, dstPath: dst });
										} else {
											task.paths.push({ srcPathMove: src, dstPathMove: dst });
										}
									}
								});
							}

							const url = task.id ? '/api/task/update' : '/api/task/add';
							$.ajax({
								url: url,
								method: 'POST',
								contentType: 'application/json',
								data: JSON.stringify(task),
								success: function (res) {
									if (res.code === 200) {
										layer.msg(res.message);
										layer.close(index);
										loadTasks(); // Reload table
									} else {
										layer.alert(res.message);
									}
								}
							});

							return false; // Prevent form submit
						});

					}
				});
			}

			function updateModalVisibility(formElem, mode) {
				if (mode === 'data') {
					formElem.find('.data-sync-config').show();
					formElem.find('.file-sync-config').hide();
				} else {
					formElem.find('.data-sync-config').hide();
					formElem.find('.file-sync-config').show();
				}
			}

			function addModalPathPair(container, src = '', dst = '') {
				const html = `
                    <div class="layui-form-item path-pair-row">
                        <div class="layui-inline">
                            <input type="text" placeholder="源目录" class="layui-input src-path" value="${src}" style="width: 200px;">
                        </div>
                        <div class="layui-inline">
                            <input type="text" placeholder="目标目录" class="layui-input dst-path" value="${dst}" style="width: 200px;">
                        </div>
                        <div class="layui-inline">
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger remove-pair-btn"><i class="layui-icon">&#xe640;</i></button>
                        </div>
                    </div>
                `;
				const $row = $(html);
				$row.find('.remove-pair-btn').click(function () {
					$row.remove();
				});
				container.append($row);
			}

			// 检查登录状态
			$.ajax({
				url: '/api/check-login',
				method: 'GET',
				success: function (res) {
					if (res.code !== 200) {
						window.location.href = '/login';
					}
				},
				error: function () {
					window.location.href = '/login';
				}
			});

			// 修改登录密码按钮点击事件
			$('#changePassword').on('click', function () {
				const isMobile = window.innerWidth <= 768;
				layer.open({
					type: 1,
					title: '修改登录密码',
					content: $('#changePasswordTpl').html(),
					area: isMobile ? ['95%', 'auto'] : ['500px', '400px'],
					maxWidth: '100%',
					success: function (layero, index) {
						// 获取当前登录用户名并填充
						var $form = layero.find('.layui-form');
						$.ajax({
							url: '/api/current-user',
							method: 'GET',
							success: function (res) {
								if (res.code === 200) {
									$form.find('input[name="oldUsername"]').val(res.data.username);
									$form.find('input[name="newUsername"]').val(res.data.username);
								}
							}
						});
					}
				});
			});

			// 修改密码表单提交
			form.on('submit(changePasswordSubmit)', function (data) {
				// 验证新用户名不能为空
				if (!data.field.newUsername.trim()) {
					layer.msg('新用户名不能为空');
					return false;
				}

				if (data.field.newPassword !== data.field.confirmPassword) {
					layer.msg('两次输入的新密码不一致');
					return false;
				}

				layer.load(1);
				$.ajax({
					url: '/api/change-password',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(data.field),
					success: function (res) {
						layer.closeAll('loading');
						if (res.code === 200) {
							layer.msg('修改成功', {
								icon: 1,
								time: 1000
							}, function () {
								layer.closeAll();
								// 如果修改了用户名,需要重新登录
								if (data.field.oldUsername !== data.field.newUsername) {
									window.location.href = '/login';
								}
							});
						} else {
							layer.msg(res.message || '修改失败');
						}
					},
					error: function () {
						layer.closeAll('loading');
						layer.msg('请求失败');
					}
				});
				return false;
			});

			// 查看日志按钮点击事件
			$('#viewLogs').on('click', function () {
				// 根据屏幕宽度设置不同的弹窗大小
				const isMobile = window.innerWidth <= 768;
				layer.open({
					type: 1,
					title: '执行日志',
					content: $('#logsViewTpl').html(),
					area: isMobile ? ['95%', '80%'] : ['800px', '600px'],
					maxWidth: '100%',
					maxHeight: '100%',
					scrollbar: false,
					success: function (layero, index) {
						// 初始化日期选择器
						laydate.render({
							elem: '#logDate',
							max: 0,
							done: function (value, date) {
								// 如果选择的是当天，传递 'current' 表示查看当前日志
								const today = new Date().toISOString().split('T')[0];
								if (value === today) {
									loadLogs('current');
								} else {
									loadLogs(value);
								}
							}
						});

						// 默认加载当前日志
						loadLogs('current');

						// 绑定刷新按钮事件
						layero.find('#refreshLogs').on('click', function () {
							var date = $('#logDate').val();
							// 如果是当天日期，查看当前日志
							const today = new Date().toISOString().split('T')[0];
							if (date === today) {
								loadLogs('current');
							} else {
								loadLogs(date);
							}
						});
					}
				});
			});

			// 修改加载日志函数
			function loadLogs(date) {
				layer.load(1);
				$.ajax({
					url: '/api/logs',
					method: 'GET',
					data: { date: date },
					success: function (res) {
						layer.closeAll('loading');
						if (res.code === 200) {
							var html = '';
							res.data.forEach(function (log) {
								html += '<div class="layui-card">';
								html += '<div class="layui-card-header">' +
									(log.date === 'current' ? '当前日志' : log.date) +
									'</div>';
								html += '<div class="layui-card-body">';
								html += '<pre style="white-space: pre-wrap; word-wrap: break-word;">' +
									log.content + '</pre>';
								html += '</div></div>';
							});
							$('.logs-content').html(html || '暂无日志');
						} else {
							layer.msg('获取日志失败: ' + res.message);
						}
					},
					error: function () {
						layer.closeAll('loading');
						layer.msg('请求失败');
					}
				});
			}

			// 为标签和选项添加悬停提示
			$(document).on('mouseenter', '.layui-form-label, input[type="radio"]', function (e) {
				var title = $(this).attr('title');
				if (title) {
					layer.tips(title, this, {
						tips: [1, '#3595CC'],
						time: 4000
					});
				}
			});

			// 修改绑定同步目标差异处置策略事件的函数
			function bindSyncDelActionEvents($task) {
				const taskId = $task.attr('data-task-id');
				const groupName = `syncDelAction_${taskId}`;

				// 为该任务的 radio 按钮添加点击事件
				$task.find(`input[name="${groupName}"]`).on('click', function () {
					const $currentGroup = $task.find(`input[name="${groupName}"]`);
					$currentGroup.not(this).prop('checked', false);
					$(this).prop('checked', true);
					// 重新渲染表单
					form.render('radio');
				});
			}

			// 在脚本末尾添加退出按钮点击事件
			$('#logoutBtn').on('click', function () {
				layer.confirm('确定要退出吗？', function (index) {
					layer.close(index);
					$.ajax({
						url: '/api/logout',
						method: 'GET',
						success: function (res) {
							if (res.code === 200) {
								window.location.href = '/login';
							} else {
								layer.msg(res.message || '退出失败');
							}
						},
						error: function () {
							layer.msg('请求失败');
						}
					});
				});
			});

			// 导出配置
			$('#exportConfig').on('click', function () {
				layer.confirm('请选择要导出的配置类型', {
					btn: ['基础配置', '同步配置', '取消']
				}, function (index) {
					// 导出基础配置
					exportConfig('base');
					layer.close(index);
				}, function (index) {
					// 导出同步配置
					exportConfig('sync');
					layer.close(index);
				});
			});

			// 导入配置
			$('#importConfig').on('click', function () {
				layer.open({
					type: 1,
					title: '导入配置',
					content: $('#importConfigTpl').html(),
					area: ['600px', '500px'],
					success: function (layero, index) {
						form.render();

						// 绑定配置类型切换事件
						form.on('radio(configType)', function (data) {
							if (data.value === 'sync') {
								// 检查基础配置是否存在
								$.ajax({
									url: '/api/get-base-config',
									method: 'GET',
									success: function (res) {
										if (res.code !== 200) {
											layer.msg('请先导入基础配置文件');
											layero.find('input[name="configType"][value="base"]').prop('checked', true);
											form.render('radio');
										}
									}
								});
							}
						});

						// 绑定文件选择事件
						layero.find('input[type="file"]').on('change', function (e) {
							var file = e.target.files[0];
							if (file) {
								var reader = new FileReader();
								reader.onload = function (e) {
									layero.find('textarea[name="configContent"]').val(e.target.result);
								};
								reader.readAsText(file);
							}
						});
					},
					btn: ['导入', '取消'],
					yes: function (index, layero) {
						var configType = layero.find('input[name="configType"]:checked').val();
						var configContent = layero.find('textarea[name="configContent"]').val();

						if (!configContent) {
							layer.msg('请选择文件或输入配置内容');
							return;
						}

						try {
							// 验证JSON格式
							var content = JSON.parse(configContent);

							// 修改基础配置验证逻辑
							if (configType === 'base') {
								if (!content.baseUrl) {
									layer.msg('基础配置文件必须包含 baseUrl');
									return;
								}
								// 检查是否至少包含token或者(username和password)
								if (!content.token && !(content.username && content.password)) {
									layer.msg('基础配置文件必须包含token或者同时包含username和password');
									return;
								}
							} else if (configType === 'sync' && !content.tasks) {
								layer.msg('无效的同步配置文件');
								return;
							}

							// 如果是同步配置,先检查基础配置是否存在
							if (configType === 'sync') {
								$.ajax({
									url: '/api/get-base-config',
									method: 'GET',
									async: false,
									success: function (res) {
										if (res.code !== 200) {
											layer.msg('请先导入基础配置文件');
											return false;
										}
									}
								});
							}

							// 发送导入请求
							$.ajax({
								url: '/api/import-config',
								method: 'POST',
								contentType: 'application/json',
								data: JSON.stringify({
									type: configType,
									content: content
								}),
								success: function (res) {
									if (res.code === 200) {
										layer.msg('导入成功', { icon: 1 }, function () {
											layer.close(index);
											// 刷新页面以加载新配置
											location.reload();
										});
									} else {
										layer.msg(res.message || '导入失败');
									}
								},
								error: function () {
									layer.msg('请求失败');
								}
							});
						} catch (e) {
							layer.msg('无效的JSON格式: ' + e.message);
						}
					}
				});
			});

			// 添加配置类型切换事件监听
			form.on('radio(configType)', function (data) {
				var $file = $('input[type="file"]');
				var fileName = $file.val();
				if (fileName) {
					var fileType = data.value;
					if (!fileName.includes(fileType)) {
						$file.val('');
						$('textarea[name="configContent"]').val('');
						layer.msg('已清除不匹配的文件');
					}
				}
			});

			// 导出配置函数
			function exportConfig(type) {
				layer.load(1);
				$.ajax({
					url: '/api/export-config',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({ type: type }),
					success: function (res) {
						layer.closeAll('loading');
						if (res.code === 200) {
							// 创建下载
							var content = JSON.stringify(res.data.content, null, 2);
							var blob = new Blob([content], { type: 'application/json' });
							var url = window.URL.createObjectURL(blob);
							var a = document.createElement('a');
							a.href = url;
							a.download = res.data.filename;
							document.body.appendChild(a);
							a.click();
							window.URL.revokeObjectURL(url);
							document.body.removeChild(a);
							layer.msg('导出成功');
						} else {
							layer.msg(res.message || '导出失败');
						}
					},
					error: function () {
						layer.closeAll('loading');
						layer.msg('请求失败');
					}
				});
			}

			// 添加获取版本信息的函数
			function loadVersionInfo() {
				$.ajax({
					url: '/api/version',
					method: 'GET',
					success: function (res) {
						if (res.code === 200) {
							$('#currentVersion').text(res.data.current_version);
							$('#latestVersion').text(res.data.latest_version);

							// 检查是否有新版本
							if (res.data.current_version !== 'unknown' &&
								res.data.latest_version !== 'unknown' &&
								res.data.current_version !== res.data.latest_version) {
								$('#latestVersion').css('color', '#ff5722')
									.attr('title', '发现新版本');
							}
						} else {
							$('#currentVersion').text('获取失败');
							$('#latestVersion').text('获取失败');
						}
					},
					error: function () {
						$('#currentVersion').text('获取失败');
						$('#latestVersion').text('获取失败');
					}
				});
			}

			// 页面加载时获取版本信息
			loadVersionInfo();
		});
	</script>
</body>

</html>